<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Netlify Functions 测试（Natal SVG）</title>
  <style>
    :root { --bg:#0e1116; --fg:#e6edf3; --muted:#9da7b3; --card:#161b22; --btn:#238636; --err:#f85149; }
    html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
         background:var(--bg); color:var(--fg);}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px}
    h1{font-size:26px; margin:.2em 0 .6em}
    .card{background:var(--card); border:1px solid #30363d; border-radius:10px; padding:18px; margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
    label{font-size:14px; color:var(--muted)}
    input,select{width:100%; background:#0b0f14; color:var(--fg); border:1px solid #30363d; border-radius:8px;
                 padding:10px 12px; font-size:16px}
    .actions{display:flex; gap:12px; margin-top:12px}
    button{background:var(--btn); color:#fff; border:0; padding:12px 16px; border-radius:8px;
           font-weight:600; cursor:pointer}
    button.secondary{background:#30363d}
    .log{white-space:pre-wrap; font-family:ui-monospace,Consolas,Menlo,monospace; font-size:13px; color:#a6d189}
    .err{color:var(--err)}
    .svgbox{background:#fff; border-radius:10px; padding:8px; overflow:auto; max-height:70vh}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>出生星盘（测试前端 / 调 Netlify Functions）</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>出生日期</label>
          <input id="date" type="date" value="1958-01-07"/>
        </div>
        <div>
          <label>出生时间（24h）</label>
          <input id="time" type="time" value="08:50"/>
        </div>
        <div>
          <label>纬度 latitude（例如 22.99083）</label>
          <input id="lat" type="text" value="22.99083" />
        </div>
        <div>
          <label>经度 longitude（例如 120.21333）</label>
          <input id="lng" type="text" value="120.21333" />
        </div>
        <div>
          <label>时区（UTC 偏移，如台湾=8）</label>
          <input id="tz" type="number" step="0.25" value="8"/>
        </div>
        <div>
          <label>语言 language</label>
          <select id="lang">
            <option value="en">English</option>
            <option value="zh">中文</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="gen">产生星盘</button>
        <button id="sample" class="secondary">填入示例</button>
        <button id="clear" class="secondary">清空结果</button>
      </div>
      <div id="status" class="log" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <details open>
        <summary>原始 API 返回</summary>
        <pre id="raw" class="log"></pre>
      </details>
      <div id="svgwrap" class="svgbox" style="display:none"></div>
      <div id="errmsg" class="err"></div>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);

function pad(n){return n.toString().padStart(2,'0')}

$("#sample").onclick = () => {
  $("#date").value = "1958-01-07";
  $("#time").value = "08:50";
  $("#lat").value  = "22.99083";
  $("#lng").value  = "120.21333";
  $("#tz").value   = "8";
  $("#lang").value = "en";
};

$("#clear").onclick = () => {
  $("#raw").textContent = "";
  $("#svgwrap").style.display = "none";
  $("#svgwrap").innerHTML = "";
  $("#errmsg").textContent = "";
  $("#status").textContent = "";
};

$("#gen").onclick = async () => {
  $("#status").textContent = "⏳ 正在请求 /.netlify/functions/natal …";
  $("#errmsg").textContent = "";
  $("#svgwrap").style.display = "none";
  $("#svgwrap").innerHTML = "";
  $("#raw").textContent = "";

  try {
    const [y,m,d] = $("#date").value.split("-").map(Number);
    const [hh,mm] = $("#time").value.split(":").map(Number);
    const lat = parseFloat($("#lat").value);
    const lng = parseFloat($("#lng").value);
    const tz  = parseFloat($("#tz").value);
    const lang = $("#lang").value;

    const payload = {
      year: y, month: m, date: d,
      hours: hh, minutes: mm, seconds: 0,
      latitude: lat, longitude: lng, timezone: tz,
      config: {
        observation_point: "topocentric",
        ayanamsha: "tropical",
        house_system: "Placidus",
        language: lang,
        exclude_planets: [],
        allowed_aspects: ["Conjunction","Opposition","Trine","Square","Sextile"]
      }
    };

    const res = await fetch("/.netlify/functions/natal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e) { data = { raw:text } }

    $("#raw").textContent = JSON.stringify(data, null, 2);

    if (!res.ok) {
      $("#errmsg").textContent = "❌ HTTP " + res.status + " " + res.statusText;
    }

    if (data && data.svg) {
      $("#svgwrap").style.display = "block";
      // 直接把 SVG 片段嵌入
      $("#svgwrap").innerHTML = data.svg;
      $("#status").textContent = "✅ 已取得 SVG 并嵌入。";
    } else if (data && data.svg_url) {
      $("#status").textContent = "✅ 返回了 svg_url，已在下方 raw 中显示，可手动打开。";
    } else if (data && data.message) {
      $("#errmsg").textContent = "⚠️ " + data.message;
      $("#status").textContent = "请求完成，但无 SVG 内容。";
    } else if (data && data.raw) {
      $("#status").textContent = "已返回非 JSON 内容，请查看 raw。";
    } else {
      $("#status").textContent = "请求完成。";
    }
  } catch (err) {
    $("#errmsg").textContent = "异常：" + err;
    $("#status").textContent = "请求失败。";
  }
};
</script>
</body>
</html>

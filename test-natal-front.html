<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出生星盤（測試前端 / 調 Netlify Functions）</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", sans-serif; 
           background:#0e1117; color:#e6edf3; margin:0; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 18px; }
    .row { display: grid; grid-template-columns: 220px 1fr; gap: 10px; margin-bottom: 12px; align-items: center; }
    .row label { opacity: 0.9; }
    input, select, textarea, button { 
      background: #161b22; color:#e6edf3; border:1px solid #30363d; border-radius:10px; padding:12px 14px; font-size: 16px;
    }
    input:focus, select:focus, textarea:focus, button:focus { outline: 2px solid #1f6feb; }
    button { cursor: pointer; border-radius: 12px; padding: 12px 16px; border: 1px solid #238636; background:#238636; }
    button.secondary { border-color:#30363d; background:#161b22; }
    .btns { display:flex; gap:10px; margin: 16px 0 8px; }
    .card { background:#0b0f14; border:1px solid #30363d; border-radius:16px; padding:16px; margin-top:18px;}
    pre { white-space: pre-wrap; word-break: break-all; margin:0; }
    .muted { opacity: 0.7; font-size: 14px; }
    .ok { color: #7ee787; }
    .bad { color: #ff7b72; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>出生星盤（測試前端 / 調 Netlify Functions）</h1>

    <div class="row">
      <label for="birthDate">出生日期</label>
      <input id="birthDate" type="date" value="1958-01-07" />
    </div>

    <div class="row">
      <label for="birthTime">出生時間（24h 或「上午 08:50／下午 8:05」）</label>
      <input id="birthTime" type="text" value="上午 08:50" />
    </div>

    <div class="row">
      <label for="lat">緯度 latitude</label>
      <input id="lat" type="number" step="0.00001" value="22.99083" />
    </div>

    <div class="row">
      <label for="lon">經度 longitude</label>
      <input id="lon" type="number" step="0.00001" value="120.21333" />
    </div>

    <div class="row">
      <label for="tz">時區 UTC 偏移</label>
      <input id="tz" type="number" step="1" value="8" />
    </div>

    <div class="row">
      <label for="lang">語言 language</label>
      <select id="lang">
        <option value="en" selected>English</option>
        <option value="zh-Hant">繁體中文</option>
        <option value="zh-Hans">簡體中文</option>
      </select>
    </div>

    <div class="btns">
      <button id="btnRun">產生星盤</button>
      <button id="btnFill" class="secondary">填入示例</button>
      <button id="btnClear" class="secondary">清空結果</button>
    </div>

    <div class="card">
      <div class="muted">Request payload</div>
      <pre id="payloadBox"></pre>
    </div>

    <div class="card">
      <div>Functions 回應 <span id="status" class="muted"></span></div>
      <pre id="resultBox"></pre>
    </div>

    <div class="card">
      <details>
        <summary class="muted">原始 API 回傳</summary>
        <pre id="upstreamBox"></pre>
      </details>
    </div>
  </div>

<script>
function parseTimeTo24h(val) {
  if (!val) return [0, 0];
  const am = /上午|AM/i.test(val);
  const pm = /下午|PM/i.test(val);
  const m = val.match(/(\d{1,2})\s*:\s*(\d{2})/);
  if (!m) return [0, 0];
  let h = parseInt(m[1], 10);
  const min = parseInt(m[2], 10);
  if (pm && h < 12) h += 12;
  if (am && h === 12) h = 0;
  return [h, min];
}

function el(id){ return document.getElementById(id); }
function showJSON(node, data){ node.textContent = JSON.stringify(data, null, 2); }

async function run() {
  const dateStr = el('birthDate').value;
  const timeStr = el('birthTime').value;
  const lat = parseFloat(el('lat').value);
  const lon = parseFloat(el('lon').value);
  const tz  = parseInt(el('tz').value, 10);
  const language = el('lang').value || 'en';

  const d = new Date(dateStr);
  const year  = d.getFullYear();
  const month = d.getMonth() + 1;
  const day   = d.getDate();

  const [hour, minute] = parseTimeTo24h(timeStr);

  const payload = { year, month, day, hour, minute, lat, lon, tz, language };
  showJSON(el('payloadBox'), payload);
  el('upstreamBox').textContent = "";
  el('resultBox').textContent = "";
  el('status').textContent = "送出中…";

  try {
    const res = await fetch('/.netlify/functions/natal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const text = await res.text();
    el('status').textContent = `HTTP ${res.status}`;
    el('resultBox').textContent = text;

    try {
      const obj = JSON.parse(text);
      if (obj && (obj.upstreamBody || obj.raw)) {
        el('upstreamBox').textContent = JSON.stringify(obj.upstreamBody || obj.raw, null, 2);
      }
    } catch(e) {}
  } catch (err) {
    el('status').textContent = '錯誤';
    el('resultBox').textContent = String(err);
  }
}

function fillDemo() {
  el('birthDate').value = '1958-01-07';
  el('birthTime').value = '上午 08:50';
  el('lat').value = '22.99083';
  el('lon').value = '120.21333';
  el('tz').value = '8';
  el('lang').value = 'en';
  clearAll();
}

function clearAll() {
  el('payloadBox').textContent = '';
  el('resultBox').textContent = '';
  el('upstreamBox').textContent = '';
  el('status').textContent = '';
}

el('btnRun').addEventListener('click', run);
el('btnFill').addEventListener('click', fillDemo);
el('btnClear').addEventListener('click', clearAll);
</script>
</body>
</html>

<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>出生星盘产生器（完整版 / 内嵌SVG / 容错增强）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0d1117;color:#e6edf3;margin:0;padding:0}
    .wrap{max-width:1000px;margin:30px auto;padding:0 16px}
    h1{font-size:28px;margin-bottom:20px}
    .card{background:#161b22;padding:18px;border-radius:10px;margin-bottom:20px;border:1px solid #30363d}
    label{font-size:14px;color:#9aa0a6;display:block;margin-top:10px}
    input,button{padding:10px;border-radius:6px;border:1px solid #30363d;font-size:15px}
    input{background:#0d1117;color:#e6edf3;width:100%}
    button{cursor:pointer;background:#238636;color:#fff;border:none}
    button.secondary{background:#30363d}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .result{background:#0d1117;border:1px dashed #30363d;padding:12px;min-height:200px;border-radius:10px;margin-top:12px}
    .err{color:#f85149;margin-top:8px;font-size:14px}
    .raw{font-family:monospace;white-space:pre-wrap;background:#0d1117;color:#9aa0a6;border:1px dashed #30363d;padding:10px;border-radius:8px;margin-top:12px}
    .svgbox{background:#fff;color:#000;padding:8px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>出生星盘产生器（完整版 / 内嵌SVG / 容错增强）</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>出生日期</label>
          <input id="date" type="date" value="1958-01-07"/>
        </div>
        <div>
          <label>出生时间（24h）</label>
          <input id="time" type="time" step="60" value="08:50"/>
        </div>
      </div>
      <label>出生地（英文）</label>
      <input id="place" type="text" value="Tainan, Taiwan"/>

      <label>经纬度（可手动覆盖）</label>
      <div class="row">
        <input id="lat" placeholder="latitude"/>
        <input id="lon" placeholder="longitude"/>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px">
        <button id="btnCheck" class="secondary">检查 Functions</button>
        <button id="btnGen">产生星盘</button>
        <button id="btnClear" class="secondary">清空结果</button>
      </div>
    </div>

    <div class="card">
      <div id="result" class="result"><em>（结果会显示在此）</em></div>
      <div id="error" class="err"></div>
      <details>
        <summary>原始 API 返回</summary>
        <div id="raw" class="raw"></div>
      </details>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
const result = $('result'), error = $('error'), raw = $('raw');

function showError(msg){ error.textContent = msg||''; }
function showRaw(obj){ raw.textContent = obj? JSON.stringify(obj,null,2):''; }
function showSVG(svg){ result.innerHTML = '<div class="svgbox">'+svg+'</div>'; }

$('btnClear').onclick = ()=>{ result.innerHTML='<em>（结果会显示在此）</em>'; showError(''); showRaw(''); };

$('btnCheck').onclick = async ()=>{
  showError(''); result.innerHTML=''; showRaw('');
  try{
    const g = await fetch('/.netlify/functions/geo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Tainan, Taiwan'})});
    const n = await fetch('/.netlify/functions/natal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ping:true})});
    result.innerHTML=`geo: ${g.status}, natal: ${n.status}`;
  }catch(e){ showError('检查失败: '+e.message); }
};

$('btnGen').onclick = async ()=>{
  showError(''); showRaw(''); result.innerHTML='生成中...';
  let lat=$('lat').value, lon=$('lon').value;
  if(!lat||!lon){
    try{
      const gr = await fetch('/.netlify/functions/geo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:$('place').value})});
      const gj = await gr.json();
      if(gj.results && gj.results[0]){ lat=gj.results[0].latitude; lon=gj.results[0].longitude; $('lat').value=lat; $('lon').value=lon; }
    }catch(e){ showError('geo 查询失败: '+e.message); result.innerHTML=''; return; }
  }
  const [y,m,d] = $('date').value.split('-').map(n=>parseInt(n,10));
  const [hh,mm] = $('time').value.split(':').map(n=>parseInt(n,10));
  const payload = {year:y,month:m,date:d,hours:hh,minutes:mm,seconds:0,latitude:parseFloat(lat),longitude:parseFloat(lon),config:{observation_point:'topocentric',ayanamsha:'tropical',house_system:'Placidus',language:'en',exclude_planets:[],allowed_aspects:['Conjunction','Opposition','Trine','Square','Sextile']}};
  try{
    const r = await fetch('/.netlify/functions/natal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data = await r.json().catch(()=>({}));
    if(data.svg){ showSVG(data.svg); }
    else if(data.svg_url){ const svg=await fetch(data.svg_url).then(x=>x.text()); showSVG(svg); }
    else{ result.innerHTML=''; showError('API 未返回 SVG / 链接'); showRaw(data); }
  }catch(e){ result.innerHTML=''; showError('natal 调用失败: '+e.message); }
};
</script>
</body>
</html>

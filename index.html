
<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出生星盘产生器（修正版 / 内嵌SVG）</title>
  <style>
    :root{--bg:#111418;--fg:#e9eef3;--muted:#9fb0c0;--card:#171b21;--btn:#4f46e5;--btn2:#0ea5e9;}
    html,body{background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:980px;margin:40px auto;padding:16px;}
    h1{font-size:28px;margin:0 0 16px;}
    fieldset{background:var(--card);border:1px solid #263141;border-radius:12px;padding:16px;margin-bottom:16px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    input,select,button,textarea{font:inherit}
    input,select{width:100%;background:#0f1318;color:var(--fg);border:1px solid #2a3646;border-radius:10px;padding:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    button{border:0;border-radius:12px;padding:12px 18px;cursor:pointer}
    .primary{background:var(--btn);color:white}
    .secondary{background:var(--btn2);color:white}
    .muted{background:#334155;color:#dbeafe}
    #result{background:#0b1118;border:1px solid #263141;border-radius:12px;min-height:220px;margin-top:16px;padding:12px;overflow:auto}
    details{margin-top:10px}
    .hint{color:var(--muted);font-size:13px}
    .badge{display:inline-block;background:#1f2937;border:1px solid #334155;color:#cfe1ff;border-radius:999px;padding:2px 10px;font-size:12px;margin-left:6px}
    .ok{background:#065f46;border-color:#0f766e}
    .no{background:#7f1d1d;border-color:#991b1b}
    svg{max-width:100%;height:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>出生星盘产生器 <span class="badge">修正版</span> <span class="badge">内嵌SVG</span></h1>

    <fieldset>
      <legend>站台</legend>
      <label>Functions 基底网址（若不懂请勿改动）</label>
      <input id="base" value="https://astro-natal-site.netlify.app" />
      <div class="hint">你的 Netlify 站台。会向 <code>{BASE}/.netlify/functions/*</code> 发送请求。</div>
    </fieldset>

    <fieldset>
      <legend>输入</legend>
      <div class="row">
        <div>
          <label>出生日期</label>
          <input type="date" id="date" value="1958-01-07">
        </div>
        <div>
          <label>出生时间（24h）</label>
          <input type="time" id="time" value="08:50" step="60">
        </div>
      </div>

      <label>出生地（英文，例如：Tainan, Taiwan）</label>
      <input id="place" value="Tainan, Taiwan" />

      <label style="margin-top:10px"><input type="checkbox" id="manual"> 改用手动经纬度</label>
      <div class="row">
        <div><label>纬度 latitude</label><input id="lat" placeholder="22.99083"></div>
        <div><label>经度 longitude</label><input id="lon" placeholder="120.21333"></div>
      </div>
      <label>时区（UTC 偏移，台湾填 8）</label>
      <input id="tz" placeholder="8">

      <div class="btns">
        <button class="secondary" id="btn-test">检查 Functions</button>
        <button class="primary" id="btn-go">产生星盘</button>
        <button class="muted" id="btn-clear">清空结果</button>
      </div>
    </fieldset>

    <div id="result"><div class="hint">（结果会显示在这里）</div></div>
    <details>
      <summary>详细除错输出</summary>
      <pre id="log" style="white-space:pre-wrap"></pre>
    </details>
  </div>

<script>
const $ = (q)=>document.querySelector(q);
const log = (...args)=>{ const t=args.map(v=>typeof v==='string'?v:JSON.stringify(v,null,2)).join(' '); $('#log').textContent += t + "\n"; };
const setHTML = (h)=>{ $('#result').innerHTML = h; };
const BASE = ()=>($('#base').value||'').replace(/\/$/, '');

async function checkFunctions() {
  $('#log').textContent='';
  const base = BASE();
  const endpoints = ['geo','natal'];
  let summary = [];
  for (const ep of endpoints){
    const url = base + '/.netlify/functions/' + ep;
    try{
      const r = await fetch(url, { method:'GET' });
      summary.push(`${ep}: ${r.status}`);
      log('CHECK', ep, '=>', r.status, r.statusText);
    }catch(e){
      summary.push(`${ep}: ERR`);
      log('CHECK', ep, 'ERR', e.message);
    }
  }
  setHTML(`<div class="hint">检查结果：${summary.join('， ')}（<b>200/405</b> 表示路由可达）</div>`);
}

function parseDateTime() {
  const d = $('#date').value;     // yyyy-mm-dd
  const t = $('#time').value;     // HH:MM
  if(!d || !t) throw new Error('请先选择日期与时间');
  const [yy,mm,dd] = d.split('-').map(n=>parseInt(n,10));
  const [HH,MM] = t.split(':').map(n=>parseInt(n,10));
  return {year:yy, month:mm, date:dd, hours:HH, minutes:MM, seconds:0};
}

async function geoResolve(place){
  const base = BASE();
  const url = base + '/.netlify/functions/geo';
  const body = { location: place };
  const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const txt = await r.text();
  log('geo status', r.status, r.statusText, '\n', txt);
  if(!r.ok) throw new Error('geo 失败：' + r.status + ' ' + r.statusText + ' ' + txt);
  return JSON.parse(txt);
}

async function fetchSVG(svgUrl){
  const r = await fetch(svgUrl);
  if(!r.ok) throw new Error('抓取 SVG 失败：' + r.status + ' ' + r.statusText);
  const svg = await r.text();
  return svg;
}

async function createChart(){
  $('#log').textContent='';
  setHTML('<div class="hint">处理中…</div>');
  try{
    const dt = parseDateTime();
    let lat, lon, tz;
    if($('#manual').checked){
      lat = parseFloat($('#lat').value);
      lon = parseFloat($('#lon').value);
      tz  = parseFloat($('#tz').value);
      if(Number.isNaN(lat) || Number.isNaN(lon) || Number.isNaN(tz)) throw new Error('经纬度或时区未填完整');
    }else{
      const place = $('#place').value.trim();
      if(!place) throw new Error('请填写出生地（英文）或改勾选手动）');
      const g = await geoResolve(place);
      lat = g.latitude;
      lon = g.longitude;
      tz  = g.timezone_offset;
      $('#lat').value = lat; $('#lon').value = lon; $('#tz').value = tz;
    }

    const base = BASE();
    const natalUrl = base + '/.netlify/functions/natal';
    const payload = {
      ...dt,
      latitude: lat, longitude: lon, timezone: tz,
      config:{
        observation_point:'topocentric',
        ayanamsha:'tropical',
        house_system:'Placidus',
        language:'en',
        exclude_planets:[],
        allowed_aspects:['Conjunction','Opposition','Trine','Square','Sextile']
      }
    };
    log('POST /natal payload =>', payload);
    const r = await fetch(natalUrl, {method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const txt = await r.text();
    log('natal status', r.status, r.statusText, '\n', txt);
    if(!r.ok) throw new Error('natal 失败：' + r.status + ' ' + r.statusText + ' ' + txt);
    const data = JSON.parse(txt);
    if(!data.svg_url) throw new Error('server 未返回 svg_url');

    const svg = await fetchSVG(data.svg_url);
    setHTML(svg);
  }catch(e){
    setHTML('<div class="hint" style="color:#fecaca">错误：' + (e.message||e) + '</div>');
    console.error(e);
  }
}

$('#btn-test').addEventListener('click', e=>{ e.preventDefault(); checkFunctions(); });
$('#btn-go').addEventListener('click', e=>{ e.preventDefault(); createChart(); });
$('#btn-clear').addEventListener('click', e=>{ e.preventDefault(); $('#result').innerHTML=''; $('#log').textContent=''; });

</script>
</body>
</html>

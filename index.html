<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>出生星盤產生器（除錯強化版 / 內嵌 SVG）</title>
  <style>
    :root{--bg:#111215;--card:#1a1c20;--text:#e6e7ea;--muted:#a6adbb;--accent:#6d8cff;--border:#2d3138;--input:#23252b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    label{font-size:14px;color:var(--muted)}
    input{width:100%;background:var(--input);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .result{margin-top:12px;padding:12px;background:#0d0f12;border:1px dashed var(--border);border-radius:10px;min-height:100px;overflow:auto}
    .msg{padding:8px 10px;border-radius:10px;background:#222631;color:#9fb3ff;margin:8px 0}
    .msg.err{background:#2a1c22;color:#ff93a8;border:1px solid #ff5c7a44}
    .msg.ok{background:#14231e;color:#7ae0bf;border:1px solid #27c09344}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .svg-holder svg{display:block;margin:auto;max-width:100%}
    pre{white-space:pre-wrap;word-break:break-all;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>出生星盤產生器（除錯強化版 / 內嵌 SVG）</h1>
    <div class="msg">站台：<code id="siteOrigin"></code></div>
    <div class="card">
      <div class="grid">
        <div>
          <label>出生日期</label>
          <input id="birthDate" type="date" />
        </div>
        <div>
          <label>出生時間（24h）</label>
          <input id="birthTime" type="time" step="60" />
        </div>
        <div>
          <label>出生地（英文，例：Tainan, Taiwan）</label>
          <input id="location" type="text" placeholder="City, Country" />
          <div class="row" style="margin-top:6px">
            <input id="manual" type="checkbox" />
            <label for="manual">改用手動經緯度</label>
          </div>
        </div>
        <div id="latlngBox" style="display:none">
          <div class="row" style="gap:8px">
            <div style="flex:1">
              <label>緯度</label>
              <input id="lat" type="number" step="0.00001" />
            </div>
            <div style="flex:1">
              <label>經度</label>
              <input id="lng" type="number" step="0.00001" />
            </div>
            <div style="flex:1">
              <label>時區</label>
              <input id="tz" type="number" step="0.5" placeholder="台灣：8" />
            </div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btn">產生星盤</button>
        <button class="btn" id="pingBtn" style="background:#4fb388">檢查 Functions</button>
      </div>
      <div id="hint" class="msg" style="display:none"></div>
      <div class="result">
        <div id="out" class="svg-holder muted">（結果會顯示在此）</div>
      </div>
      <details style="margin-top:10px">
        <summary>詳細除錯輸出</summary>
        <pre id="log"></pre>
      </details>
    </div>
  </div>
<script>
const $=q=>document.querySelector(q);
const logEl=$('#log'); const out=$('#out'); const hint=$('#hint'); const btn=$('#btn'); const pingBtn=$('#pingBtn');
const manual=$('#manual'); const latlngBox=$('#latlngBox'); const lat=$('#lat'); const lng=$('#lng'); const tz=$('#tz');
const birthDate=$('#birthDate'); const birthTime=$('#birthTime'); const locationInput=$('#location');
$('#siteOrigin').textContent=location.origin;
(() => {const d=new Date();const pad=n=>String(n).padStart(2,'0');birthDate.value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;birthTime.value='08:00';})();
manual.addEventListener('change',()=>{latlngBox.style.display=manual.checked?'':'none'});

function log(...a){console.log(...a); logEl.textContent += a.map(x=> typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ') + '\\n';}

function url(p){return location.origin.replace(/\\/$/,'') + (p.startsWith('/')?'':'/') + p;}

async function postJSON(u,data){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), 15000);
  log('POST', u, data);
  const r = await fetch(u, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data),signal:controller.signal});
  clearTimeout(timer);
  log('status', r.status, r.statusText);
  if(!r.ok){
    const t = await r.text().catch(()=>'');
    throw new Error('HTTP '+r.status+' '+r.statusText+'\\n'+t);
  }
  return r.json();
}

function show(msg,type){hint.style.display='block';hint.className='msg'+(type==='err'?' err':(type==='ok'?' ok':''));hint.textContent=msg;}

async function pingFunctions(){
  try{
    const g = await fetch(url('/.netlify/functions/geo'));
    const n = await fetch(url('/.netlify/functions/natal'));
    log('GET /geo ->', g.status, g.statusText);
    log('GET /natal ->', n.status, n.statusText);
    if(g.status===405 && n.status===405){
      show('Functions 可達（GET 405 屬正常）。', 'ok');
    }else{
      show('Functions 連線異常，請確認部署。', 'err');
    }
  }catch(e){
    log('ping error', e.name, e.message);
    show('無法連到 Functions：'+e.message, 'err');
  }
}

pingBtn.addEventListener('click', pingFunctions);

btn.addEventListener('click', async () => {
  hint.style.display='none'; out.textContent='產生中…'; btn.disabled=true; logEl.textContent='';
  try{
    const [y,m,d]=birthDate.value.split('-').map(Number);
    const [hh,mm]=(birthTime.value||'00:00').split(':').map(Number);
    let latV, lngV, tzV;
    if(manual.checked){
      latV=parseFloat(lat.value); lngV=parseFloat(lng.value); tzV=parseFloat(tz.value||'8');
      if(!isFinite(latV)||!isFinite(lngV)) throw new Error('請輸入有效經緯度');
    }else{
      const q=locationInput.value.trim(); if(!q) throw new Error('請輸入地點');
      const geo=await postJSON(url('/.netlify/functions/geo'),{location:q});
      log('geo resp', geo);
      const hit = Array.isArray(geo) ? (geo.find(r => /taiwan/i.test(r.country||'')||/asia\\/taipei/i.test(r.timezone||'')) || geo[0]) : geo;
      if(!hit) throw new Error('找不到地點');
      latV=parseFloat(hit.latitude); lngV=parseFloat(hit.longitude); tzV=parseFloat(hit.timezone_offset||8);
    }
    const payload={year:y,month:m,date:d,hours:hh,minutes:mm,seconds:0,latitude:latV,longitude:lngV,timezone:tzV,
      config:{observation_point:'topocentric',ayanamsha:'tropical',house_system:'Placidus',language:'en',exclude_planets:[],allowed_aspects:['Conjunction','Opposition','Trine','Square','Sextile']}};
    const natal=await postJSON(url('/.netlify/functions/natal'),payload);
    log('natal resp', natal);
    const svgUrl = natal.output || natal.url || natal.svg || natal.result;
    if(!svgUrl) throw new Error('後端未回傳 SVG/URL 欄位');
    const txt = await fetch(svgUrl).then(r=>r.text());
    out.innerHTML = txt;
    show('完成！已內嵌 Classic SVG。', 'ok');
  }catch(e){
    log('ERR', e.name, e.message);
    show((e.name==='AbortError'?'請求逾時：':'錯誤：') + e.message, 'err');
    out.textContent='（沒有結果）';
  }finally{
    btn.disabled=false;
  }
});
</script>
</body>
</html>
